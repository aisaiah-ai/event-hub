rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin(eventId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/events/$(eventId)/admins/$(request.auth.token.email)) &&
        get(/databases/$(database)/documents/events/$(eventId)/admins/$(request.auth.token.email)).data.role == "ADMIN";
    }

    function isStaff(eventId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/events/$(eventId)/admins/$(request.auth.token.email)) &&
        (
          get(/databases/$(database)/documents/events/$(eventId)/admins/$(request.auth.token.email)).data.role == "STAFF" ||
          get(/databases/$(database)/documents/events/$(eventId)/admins/$(request.auth.token.email)).data.role == "ADMIN"
        );
    }

    match /events/{eventId} {

      allow read: if true;

      match /rsvps/{rsvpId} {
        allow create, read: if true;
        allow update, delete: if isStaff(eventId);
      }

      match /registrants/{registrantId} {
        allow read: if isStaff(eventId);
        allow write: if isStaff(eventId);
      }

      match /schemas/{docId} {
        allow read: if isStaff(eventId);
        allow write: if isAdmin(eventId);
      }

      match /sessions/{sessionId} {
        allow read: if true;

        match /attendance/{registrantId} {
          allow read: if isStaff(eventId);
          allow create: if isStaff(eventId);
        }
      }

      match /formationSignals/{registrantId} {
        allow read: if isStaff(eventId);
        allow write: if isStaff(eventId);
      }

      match /admins/{email} {
        allow read: if isAdmin(eventId);
        allow write: if isAdmin(eventId);
      }
    }
  }
}
