rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin(eventId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/events/$(eventId)/admins/$(request.auth.token.email)) &&
        get(/databases/$(database)/documents/events/$(eventId)/admins/$(request.auth.token.email)).data.role == "ADMIN";
    }

    function isStaff(eventId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/events/$(eventId)/admins/$(request.auth.token.email)) &&
        (
          get(/databases/$(database)/documents/events/$(eventId)/admins/$(request.auth.token.email)).data.role == "STAFF" ||
          get(/databases/$(database)/documents/events/$(eventId)/admins/$(request.auth.token.email)).data.role == "ADMIN"
        );
    }

    function selfCheckinEnabled(eventId) {
      return eventId == 'nlc-2026' || (exists(/databases/$(database)/documents/events/$(eventId))
        && get(/databases/$(database)/documents/events/$(eventId)).data.get('metadata', {}).get('selfCheckinEnabled', false) == true);
    }

    function isSelfCheckinRegistrantUpdate() {
      return (request.auth == null || request.auth.token.firebase.sign_in_provider == 'anonymous')
        && request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['eventAttendance', 'checkInSource', 'updatedAt', 'sessionsCheckedIn']);
    }

    match /events/{eventId} {

      allow read: if true;

      match /rsvps/{rsvpId} {
        allow create, read: if true;
        allow update, delete: if isStaff(eventId);
      }

      match /registrants/{registrantId} {
        // Public read for nlc-2026 (check-in search). Staff: full access.
        // selfCheckinEnabled: public read when event allows self-check-in.
        allow read: if eventId == 'nlc-2026'
          || isStaff(eventId)
          || selfCheckinEnabled(eventId);
        // Update: staff OR unauthenticated self-check-in (eventAttendance only)
        allow update: if (
            // Staff full access
            (request.auth != null && isStaff(eventId))
            ||
            // Anonymous public arrival check-in (Relaxed for debugging)
            (
              eventId == 'nlc-2026' &&
              (request.auth == null || request.auth.token.firebase.sign_in_provider == 'anonymous') &&
              // Only allow updating eventAttendance
              request.resource.data.diff(resource.data).affectedKeys().hasOnly(['eventAttendance'])
            )
        );
      }

      match /schemas/{docId} {
        allow read: if isStaff(eventId);
        allow write: if isAdmin(eventId);
      }

      match /sessions/{sessionId} {
        allow read: if true;
        // Client may update only attendanceCount (+1) and updatedAt (transactional capacity).
        // Use 'field' in resource.data to avoid errors when field is missing (legacy docs).
        allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attendanceCount', 'updatedAt'])
          && (
            ('attendanceCount' in resource.data && request.resource.data.attendanceCount == resource.data.attendanceCount + 1)
            || (!('attendanceCount' in resource.data) && request.resource.data.attendanceCount == 1)
          );
        allow create, delete: if false;

        // Session attendance: allow create/read so self-check-in works (no auth required).
        match /attendance/{registrantId} {
          allow create, read: if true;
          allow update, delete: if false;
        }

        // Session analytics: Cloud Functions only write; read for NLC dashboard.
        match /analytics/{docId} {
          allow read: if true;
          allow write: if false;
        }
      }

      // Pre-registration: client read only (admin/backend writes).
      match /sessionRegistrations/{registrantId} {
        allow read: if true;
        allow write: if false;
      }

      // Stats: Cloud Functions only can write; staff can read.
      match /stats/{doc} {
        allow read: if isStaff(eventId);
        allow write: if false;
        match /checkinBuckets/{bucketId} {
          allow read: if isStaff(eventId);
          allow write: if false;
        }
      }

      // Global analytics: Cloud Functions only write; read for NLC dashboard.
      match /analytics/{docId} {
        allow read: if true;
        allow write: if false;
      }

      // Attendee index: Cloud Functions only write; authenticated read.
      match /attendeeIndex/{registrantId} {
        allow read: if request.auth != null;
        allow write: if false;
      }

      match /formationSignals/{registrantId} {
        allow read: if isStaff(eventId);
        allow write: if isStaff(eventId)
          || (selfCheckinEnabled(eventId) && request.auth == null);
      }

      match /admins/{email} {
        allow read: if isAdmin(eventId);
        allow write: if isAdmin(eventId);
      }

      // Dashboard/wallboard layout preferences. Staff can read/write.
      match /settings/{docId} {
        allow read, write: if isStaff(eventId);
      }
    }
  }
}
