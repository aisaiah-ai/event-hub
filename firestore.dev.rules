rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Deny everything by default
    match /{document=**} {
      allow read, write: if false;
    }

    match /events/{eventId} {

      allow read: if eventId == "nlc-2026";

      match /stats/{doc} {
        allow read: if request.auth != null;
        allow write: if false;
        match /checkinBuckets/{bucketId} {
          allow read: if request.auth != null;
          allow write: if false;
        }
      }

      match /registrants/{registrantId} {

        // Allow public read for NLC
        allow read: if eventId == "nlc-2026";

        // Create/delete: authenticated only
        allow create, delete: if request.auth != null;
        // Update: staff OR unauthenticated self-check-in when eventId is nlc-2026
        allow update: if request.auth != null
          || (eventId == "nlc-2026" && request.auth == null);
      }

      match /checkins/{checkinId} {
        allow read: if request.auth != null;
        allow create: if eventId == "nlc-2026" && request.auth == null
          && request.resource.data.eventId == eventId
          && request.resource.data.sessionId is string
          && request.resource.data.method in ['qr', 'search', 'manual']
          && request.resource.data.source == 'self';
      }

      match /sessions/{sessionId}/attendance/{registrantId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null
          || (eventId == "nlc-2026" && request.auth == null);
      }

      match /formationSignals/{registrantId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null
          || (eventId == "nlc-2026" && request.auth == null);
      }
    }
  }
}
